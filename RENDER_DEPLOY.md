# Hướng dẫn Deploy lên Render

## Các thay đổi đã thực hiện

### 1. Backend (`backend/package.json`)
✅ Thêm `"type": "module"` để hỗ trợ ES modules
✅ Sửa script `start` từ `node -r @babel/register` → `node src/server.js`
✅ Thêm script `build` để build frontend trước khi deploy

### 2. Database Config (`backend/src/config/config.json`)
✅ Thêm SSL config cho PostgreSQL production:
```json
{
  "dialectOptions": {
    "ssl": {
      "require": true,
      "rejectUnauthorized": false
    }
  }
}
```

### 3. Server (`backend/src/server.js`)
✅ Hỗ trợ nhiều đường dẫn frontend build:
- `../frontend/dist`
- `../FE/dist`
- `./public`

## Cấu hình Render

### 1. Tạo PostgreSQL Database
1. Vào Render Dashboard → New → PostgreSQL
2. Chọn free tier hoặc paid
3. Copy **Internal Database URL** (có dạng `postgresql://user:pass@...`)

### 2. Tạo Web Service
1. Vào Render Dashboard → New → Web Service
2. Connect GitHub repository: `Rin111124/Fastfood-WEB`
3. Cấu hình:

**Build & Deploy:**
- **Root Directory**: `backend`
- **Build Command**: `npm install && npm run build`
- **Start Command**: `npm start`
- **Environment**: `Node`

**Environment Variables:**
```env
NODE_ENV=production
PORT=3000
DATABASE_URL=<PostgreSQL Internal Database URL>

# JWT
TOKEN_ISSUER=fatfood-api
TOKEN_SECRET=<your-secret-key>
TOKEN_EXPIRATION=24h

# Stripe (optional)
STRIPE_SECRET_KEY=<your-stripe-key>
STRIPE_WEBHOOK_SECRET=<your-webhook-secret>

# PayPal (optional)
PAYPAL_CLIENT_ID=<your-paypal-id>
PAYPAL_CLIENT_SECRET=<your-paypal-secret>
PAYPAL_MODE=sandbox

# CORS
ALLOWED_ORIGINS=https://your-render-domain.onrender.com

# Frontend (optional - nếu build riêng)
FRONTEND_STATIC_ROOT=/opt/render/project/src/frontend/dist
```

**Auto-Deploy:**
- ✅ Enable auto-deploy from `master` branch

### 3. Database Migration
Sau khi deploy lần đầu:

**Option 1: Render Shell (Recommended)**
```bash
# Vào Render Dashboard → Web Service → Shell
npm run migrate
```

**Option 2: Local với DATABASE_URL**
```bash
# Set DATABASE_URL từ Render PostgreSQL (Internal URL)
export DATABASE_URL="postgresql://user:pass@host/db"
cd backend
npm run migrate
```

**Option 3: Manual SQL (nếu migration script lỗi)**
```bash
# Connect qua psql
psql $DATABASE_URL
# Hoặc dùng pgAdmin với External Database URL
```

## Build Process

### Local test build
```bash
# Build frontend
cd frontend
npm install
npm run build

# Start backend
cd ../backend
npm install
npm start
```

Truy cập: `http://localhost:3000` → phải thấy frontend

### Production build flow
1. Render clone repo
2. Chuyển vào `backend/` directory
3. Chạy `npm install` (cài dependencies)
4. Chạy `npm run build` → build frontend vào `frontend/dist`
5. Chạy `npm start` → khởi động server
6. Server tự động serve frontend từ `frontend/dist`

## Troubleshooting

### ❌ SSL/TLS required
→ Đã fix trong `config.json` với SSL settings

### ❌ Module type warning
→ Đã fix thêm `"type": "module"` vào `package.json`

### ❌ No frontend build found
→ Kiểm tra:
1. Script `build:frontend` chạy thành công?
2. Folder `frontend/dist` có tồn tại?
3. File `frontend/dist/index.html` có tồn tại?

Nếu không, set `FRONTEND_STATIC_ROOT` env variable

### ❌ Database connection timeout
→ Kiểm tra:
1. DATABASE_URL có đúng không (Internal URL, không phải External)
2. SSL settings có đúng không
3. PostgreSQL instance có đang chạy không

### ❌ CORS errors
→ Set `ALLOWED_ORIGINS` với domain của Render app

## Logs & Monitoring

**View logs:**
Render Dashboard → Web Service → Logs

**Healthcheck:**
```bash
curl https://your-app.onrender.com/healthz
```

Response:
```json
{"status":"ok","timestamp":"2025-11-15T..."}
```

## Database Backup

**Automatic:**
Render PostgreSQL có auto-backup (paid plans)

**Manual:**
```bash
# Export
pg_dump $DATABASE_URL > backup.sql

# Import
psql $DATABASE_URL < backup.sql
```

## Monorepo Structure

```
NodeJS/
├── backend/
│   ├── package.json (type: module, start: node src/server.js)
│   ├── src/
│   │   ├── server.js
│   │   ├── config/config.json (SSL enabled)
│   │   └── ...
│   └── ...
├── frontend/
│   ├── package.json (build script)
│   ├── dist/ (generated by build)
│   └── ...
└── RENDER_DEPLOY.md
```

## Deploy Steps

1. ✅ Push code lên GitHub
2. ✅ Tạo PostgreSQL database trên Render
3. ✅ Tạo Web Service, config như trên
4. ✅ Set environment variables
5. ✅ Trigger deploy
6. ✅ Chạy migrations
7. ✅ Test: `https://your-app.onrender.com/healthz`
8. ✅ Test frontend: `https://your-app.onrender.com`
